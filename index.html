<!doctype html>
<html lang="ro">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>VeÈ™ti bune</title>
  <meta name="description" content="Doar È™tiri pozitive. RomÃ¢nia (RO) + Global (EN). Actualizat automat." />
  <style>
    :root{color-scheme:light}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:0;background:#fafafa;color:#111}
    header{position:sticky;top:0;background:#fff;border-bottom:1px solid #e8e8e8;z-index:10}
    .wrap{max-width:1100px;margin:0 auto;padding:14px 16px}
    h1{margin:0;font-size:20px}
    .sub{margin-top:4px;color:#555;font-size:13px}
    .bar{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-top:10px}
    .btn{border:1px solid #ddd;background:#fff;padding:8px 10px;border-radius:999px;cursor:pointer;font-size:13px}
    .btn.active{border-color:#111}
    .pill{font-size:12px;background:#111;color:#fff;padding:4px 8px;border-radius:999px}
    main .wrap{padding-top:18px}
    .grid{display:grid;grid-template-columns:1fr;gap:12px}
    @media(min-width:900px){.grid{grid-template-columns:1fr 1fr}}
    .card{background:#fff;border:1px solid #eaeaea;border-radius:16px;padding:14px;box-shadow:0 1px 0 rgba(0,0,0,.02)}
    .meta{display:flex;gap:8px;flex-wrap:wrap;align-items:center;color:#666;font-size:12px;margin-bottom:8px}
    .src{font-weight:600;color:#333}
    .title{margin:6px 0 8px;font-size:16px;line-height:1.35}
    .title a{color:#111;text-decoration:none}
    .title a:hover{text-decoration:underline}
    .sum{color:#333;font-size:13px;line-height:1.5;margin:0;white-space:pre-line}
    .sec{display:flex;gap:8px;align-items:center;margin:18px 0 10px}
    .sec h2{margin:0;font-size:16px}
    .muted{color:#666;font-size:13px}
    .error{background:#fff2f2;border:1px solid #ffd0d0;padding:12px;border-radius:12px}
    footer{color:#666;font-size:12px;padding:18px 0 30px}
    code{background:#f3f3f3;padding:2px 6px;border-radius:8px}
    .toprow{display:grid;grid-template-columns:1fr;gap:12px;margin:12px 0 6px}
    @media(min-width:900px){.toprow{grid-template-columns:2fr 1fr}}
    .imggrid{display:grid;grid-template-columns:1fr;gap:10px}
    .imgcard img{width:100%;border-radius:14px;display:block;max-height:210px;object-fit:cover;border:1px solid #f1f1f1}
    .imgcard a{color:#111;text-decoration:none}
    .imgcard a:hover{text-decoration:underline}
    .joke{font-size:14px;line-height:1.5}
  </style>
</head>
<body>
<header>
  <div class="wrap">
    <h1>VeÈ™ti bune <span class="pill">beta</span></h1>
    <div class="sub">RomÃ¢nia (RO) + Global (EN). Actualizat automat.</div>
    <div class="bar">
      <button id="btnMix" class="btn active">âœ¨ Mix</button>
      <button id="btnRO" class="btn">RomÃ¢nia</button>
      <button id="btnEN" class="btn">Global (EN)</button>
      <span id="stamp" class="muted"></span>
    </div>
  </div>
</header>

<main>
  <div class="wrap">
    <div id="status"></div>

    <div class="toprow">
      <div class="card">
        <div class="meta"><span class="src">ðŸ“¸ Top poze</span><span>â€¢</span><span class="muted">space / animals / landscape</span></div>
        <div id="topImages" class="imggrid"></div>
      </div>
      <div class="card">
        <div class="meta"><span class="src">ðŸ˜„ Gluma zilei</span></div>
        <div id="joke" class="joke muted">â€”</div>
      </div>
    </div>

    <div id="content"></div>

    <footer>
      Tip: hard refresh <code>Cmd+Shift+R</code> / <code>Ctrl+F5</code>.<br/>
      Date: <a href="./data/items.json">items.json</a> â€¢ <a href="./data/news.json">news.json</a>
    </footer>
  </div>
</main>

<script>
  // Robust: Ã®ncercÄƒm items.json, apoi news.json (ca sÄƒ nu mai crape cÃ¢nd un fiÈ™ier lipseÈ™te)
  const DATA_URLS = ["./data/items.json", "./data/news.json"];

  const state = { mode: "mix", data: null };

  const els = {
    btnMix: document.getElementById("btnMix"),
    btnRO: document.getElementById("btnRO"),
    btnEN: document.getElementById("btnEN"),
    stamp: document.getElementById("stamp"),
    status: document.getElementById("status"),
    content: document.getElementById("content"),
    topImages: document.getElementById("topImages"),
    joke: document.getElementById("joke"),
  };

  function setActive() {
    els.btnMix.classList.toggle("active", state.mode === "mix");
    els.btnRO.classList.toggle("active", state.mode === "ro");
    els.btnEN.classList.toggle("active", state.mode === "en");
  }

  function fmtDate(iso) {
    try { return new Date(iso).toLocaleString("ro-RO",{dateStyle:"medium",timeStyle:"short"}); }
    catch(e){ return iso||""; }
  }

  function esc(s){ return (s||"").replace(/[&<>"']/g,c=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[c])); }

  function renderItems(title, items) {
    const cards = (items||[]).map(it => `
      <div class="card">
        <div class="meta">
          <span class="src">${esc(it.source || it.section || "")}</span>
          <span>â€¢</span>
          <span>${esc(fmtDate(it.published_utc))}</span>
          ${typeof it.score !== "undefined" ? `<span>â€¢</span><span>score ${esc(String(it.score))}</span>` : ""}
        </div>
        <div class="title"><a href="${esc(it.link||"#")}" target="_blank" rel="noopener noreferrer">${esc(it.title||"")}</a></div>
        <p class="sum">${esc(it.summary || it.summary_ro || "")}</p>
      </div>
    `).join("");

    return `
      <div class="sec"><h2>${esc(title)}</h2><span class="muted">(${(items||[]).length})</span></div>
      <div class="grid">${cards || `<div class="muted">Nimic de afiÈ™at Ã®ncÄƒ.</div>`}</div>
    `;
  }

  function pickSections() {
    const sections = state.data?.sections || {};
    const ro = sections.romania || [];
    const globals = Object.keys(sections).filter(k=>k!=="romania").reduce((a,k)=>(a[k]=sections[k],a),{});
    return { ro, globals };
  }

  function renderTopBlocks() {
    // Top images
    const imgs = state.data?.top_images || state.data?.topImages || [];
    els.topImages.innerHTML = (imgs || []).map(it => `
      <div class="imgcard">
        <a href="${esc(it.link||"#")}" target="_blank" rel="noopener noreferrer">
          <img src="${esc(it.image||"")}" alt="">
          <div class="muted" style="margin-top:6px">${esc(it.title||it.tag||"")}</div>
        </a>
      </div>
    `).join("") || `<div class="muted">Nu am poze acum (verificÄƒ generatorul).</div>`;

    // Joke
    const joke = state.data?.joke_ro?.text || state.data?.joke || "";
    els.joke.textContent = joke || "â€”";
    els.joke.classList.toggle("muted", !joke);
  }

  function render() {
    setActive();
    if (!state.data) return;

    els.stamp.textContent = state.data.generated_utc ? `Ultima actualizare: ${fmtDate(state.data.generated_utc)}` : "";
    renderTopBlocks();

    const { ro, globals } = pickSections();
    let html = "";

    if (state.mode === "ro") {
      html += renderItems("RomÃ¢nia (RO)", ro);
    } else if (state.mode === "en") {
      for (const [k,arr] of Object.entries(globals)) html += renderItems(`${k.toUpperCase()} (EN)`, arr);
    } else {
      html += renderItems("RomÃ¢nia (RO)", ro);
      for (const k of Object.keys(globals).slice(0,2)) html += renderItems(`${k.toUpperCase()} (EN)`, globals[k]);
    }

    els.content.innerHTML = html;
  }

  async function fetchFirstWorkingJson() {
    let lastErr = null;
    for (const url of DATA_URLS) {
      try {
        const r = await fetch(url, { cache:"no-store" });
        if (!r.ok) throw new Error(`${url}: ${r.status} ${r.statusText}`);
        return await r.json();
      } catch (e) { lastErr = e; }
    }
    throw lastErr || new Error("No JSON available");
  }

  async function load() {
    els.status.innerHTML = `<div class="muted">ÃŽncarc dateleâ€¦</div>`;
    try {
      state.data = await fetchFirstWorkingJson();
      els.status.innerHTML = "";
      render();
    } catch (e) {
      els.status.innerHTML = `<div class="error"><b>Nu pot Ã®ncÄƒrca datele.</b><br/>${esc(String(e))}</div>`;
    }
  }

  els.btnMix.onclick=()=>{state.mode="mix";render();};
  els.btnRO.onclick =()=>{state.mode="ro";render();};
  els.btnEN.onclick =()=>{state.mode="en";render();};

  load();
</script>
</body>
</html>
